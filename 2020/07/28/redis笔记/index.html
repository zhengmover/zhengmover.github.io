<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>redis笔记 | 郑昊辉的博客</title>
    <meta name="author" content="郑昊辉" />
    <meta name="keywords" content="" />
    <meta name="description" content="Redis笔记NoSql概述单机MySQL的年代！90年代，一个基本的网站访问量一般不会太大，单个数据库完全足够！那个时候，更多的去使用静态网页Html~服务器根本没有太大压力思考一下，这种情况下：整个网站的瓶颈是什么？1、数据量如果太大了，一个机器放不下了2、数据的索引（B+Tree），一个机器内存也放不下3、访问量（读写混合），一个服务器承受不了~只要你开始出现以上三种情况之一，那么你就必须要晋级2、Memcached（缓存）+ MySQL + 垂直拆分（读写分..." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="郑昊辉的博客" type="application/atom+xml">
    
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 4.2.1"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">郑昊辉的博客</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis笔记"><span class="toc-number">1.</span> <span class="toc-text">Redis笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSql概述"><span class="toc-number">1.1.</span> <span class="toc-text">NoSql概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么使用NoSQL"><span class="toc-number">1.2.</span> <span class="toc-text">为什么使用NoSQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是NoSQL"><span class="toc-number">1.3.</span> <span class="toc-text">什么是NoSQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#阿里巴巴演进分析"><span class="toc-number">1.4.</span> <span class="toc-text">阿里巴巴演进分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSQL的四大分类"><span class="toc-number">1.5.</span> <span class="toc-text">NoSQL的四大分类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis入门"><span class="toc-number">2.</span> <span class="toc-text">Redis入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试性能"><span class="toc-number">2.2.</span> <span class="toc-text">测试性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础知识"><span class="toc-number">2.3.</span> <span class="toc-text">基础知识</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五大数据类型"><span class="toc-number">3.</span> <span class="toc-text">五大数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-Key"><span class="toc-number">3.1.</span> <span class="toc-text">Redis-Key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#String-字符串"><span class="toc-number">3.2.</span> <span class="toc-text">String(字符串)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#List"><span class="toc-number">3.3.</span> <span class="toc-text">List</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Set（集合）"><span class="toc-number">3.4.</span> <span class="toc-text">Set（集合）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash（哈希）"><span class="toc-number">3.5.</span> <span class="toc-text">Hash（哈希）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zset（有序集合）"><span class="toc-number">3.6.</span> <span class="toc-text">Zset（有序集合）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三种特殊数据类型"><span class="toc-number">4.</span> <span class="toc-text">三种特殊数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#geospatial（地理位置）"><span class="toc-number">4.1.</span> <span class="toc-text">geospatial（地理位置）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hyperloglog"><span class="toc-number">4.2.</span> <span class="toc-text">hyperloglog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bitmap"><span class="toc-number">4.3.</span> <span class="toc-text">bitmap</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#事务"><span class="toc-number">5.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jedis"><span class="toc-number">6.</span> <span class="toc-text">jedis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot整合"><span class="toc-number">7.</span> <span class="toc-text">SpringBoot整合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-conf详解"><span class="toc-number">8.</span> <span class="toc-text">Redis.conf详解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis持久化"><span class="toc-number">9.</span> <span class="toc-text">Redis持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB（Redis-DataBase）"><span class="toc-number">9.1.</span> <span class="toc-text">RDB（Redis DataBase）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF（Append-Only-File）"><span class="toc-number">9.2.</span> <span class="toc-text">AOF（Append Only File）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis发布订阅"><span class="toc-number">10.</span> <span class="toc-text">Redis发布订阅</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis主从复制"><span class="toc-number">11.</span> <span class="toc-text">Redis主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概念"><span class="toc-number">11.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境配置"><span class="toc-number">11.2.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一主二从"><span class="toc-number">11.3.</span> <span class="toc-text">一主二从</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#哨兵模式"><span class="toc-number">11.4.</span> <span class="toc-text">哨兵模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis缓存穿透和雪崩（高频）"><span class="toc-number">12.</span> <span class="toc-text">Redis缓存穿透和雪崩（高频）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存穿透"><span class="toc-number">12.1.</span> <span class="toc-text">缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#布隆过滤器"><span class="toc-number">12.1.1.</span> <span class="toc-text">布隆过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存空对象"><span class="toc-number">12.1.2.</span> <span class="toc-text">缓存空对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存击穿（量太大，缓存过期）"><span class="toc-number">12.2.</span> <span class="toc-text">缓存击穿（量太大，缓存过期）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置热点数据永不过期"><span class="toc-number">12.2.1.</span> <span class="toc-text">设置热点数据永不过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加互斥锁"><span class="toc-number">12.2.2.</span> <span class="toc-text">加互斥锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存雪崩"><span class="toc-number">12.3.</span> <span class="toc-text">缓存雪崩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis高可用"><span class="toc-number">12.3.1.</span> <span class="toc-text">redis高可用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#限流降级"><span class="toc-number">12.3.2.</span> <span class="toc-text">限流降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据预热"><span class="toc-number">12.3.3.</span> <span class="toc-text">数据预热</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            redis笔记
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://yoursite.com/2020/07/28/redis%E7%AC%94%E8%AE%B0/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2020-07-28T01:58:43.000Z" itemprop="datePublished">2020-07-28</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/NoSql/" rel="tag">NoSql</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="Redis笔记"><a href="#Redis笔记" class="headerlink" title="Redis笔记"></a>Redis笔记</h1><h2 id="NoSql概述"><a href="#NoSql概述" class="headerlink" title="NoSql概述"></a>NoSql概述</h2><blockquote>
<p>单机MySQL的年代！</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/redis%E6%88%AA%E5%9B%BE1.PNG" alt></p>
</blockquote>
<p>90年代，一个基本的网站访问量一般不会太大，单个数据库完全足够！</p>
<p>那个时候，更多的去使用静态网页Html~服务器根本没有太大压力</p>
<p>思考一下，这种情况下：整个网站的瓶颈是什么？</p>
<p>1、数据量如果太大了，一个机器放不下了</p>
<p>2、数据的索引（B+Tree），一个机器内存也放不下</p>
<p>3、访问量（读写混合），一个服务器承受不了~</p>
<p>只要你开始出现以上三种情况之一，那么你就必须要晋级</p>
<blockquote>
<p>2、Memcached（缓存）+ MySQL + 垂直拆分（读写分离）</p>
</blockquote>
<p>网站80%的情况都是在读，每次都要去查询数据库的话就十分麻烦，所以说我们希望减轻数据的压力，我们可以使用缓存来保证效率。</p>
<p>发展过程：优化数据结构和索引—》文件缓存（IO）—》Memcached（当时最热门的技术！）</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/redis%E6%88%AA%E5%9B%BE2.PNG" alt></p>
<blockquote>
<p>分库分表+水平拆分+MySQL集群</p>
</blockquote>
<p>技术和业务在发展的同时，对人的要求也越来越高</p>
<p>==本质：数据库（读，写）==</p>
<p>早些年MyISAM：表锁，十分影响效率，高并发下就会出现严重的锁问题</p>
<p>转战Innodb：行锁</p>
<p>慢慢的就开始使用分库分表来解决写的压力</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/redis%E6%88%AA%E5%9B%BE3.PNG" alt></p>
<blockquote>
<p>4、如今最近的年代</p>
</blockquote>
<p>2010–2020十年之间，世界发生了翻天覆地的变化；（定位，也是一些数据）</p>
<p>MySQL等关系数据库就不够用了，数据量很多，变化很快</p>
<p>MySQL有的使用它来存储一些比较大的文件，博客，图片，数据库表很大，效率就低了，如果有一种数据库专门来处理这种数据，MySQL压力就变得十分小。（研究如何处理这些问题）大数据的IO压力下，表几乎没法更大</p>
<blockquote>
<p>目前一个基本的互联网项目</p>
</blockquote>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/redis%E6%88%AA%E5%9B%BE4.PNG" alt></p>
<h2 id="为什么使用NoSQL"><a href="#为什么使用NoSQL" class="headerlink" title="为什么使用NoSQL"></a>为什么使用NoSQL</h2><p>用户的个人信息，社交网络，地理位置。用户自己产生的数据，用户日志等等爆发式增长</p>
<p>这时候我们就需要使用NoSQL数据库的，NoSQL数据库可以很好地解决以上问题</p>
<h2 id="什么是NoSQL"><a href="#什么是NoSQL" class="headerlink" title="什么是NoSQL"></a>什么是NoSQL</h2><blockquote>
<p>NoSQL</p>
</blockquote>
<p>NoSQL = Not Only SQL （不仅仅是SQL）</p>
<p>关系型数据库：表格，行，列</p>
<p>泛指非关系型数据库的，随着web2.0互联网的诞生，传统的关系型数据库很难对付web2.0时代，尤其是超大规模的高并发的社区。暴露出来很多难以克服的问题，NoSQL在当今大数据环境下发展的十分迅速，Redis是发展最快的，而且是我们当下必须要掌握的一个技术。</p>
<p>很多的数据类型用户的个人信息，社交网络，地理位置。这些数据类型的存储不需要一个固定的格式，不需要多余的操作就可以横向扩展的。Map&lt;String,Object&gt;使用键值对来控制。</p>
<blockquote>
<p>NoSQL特点</p>
</blockquote>
<p>1、方便扩展（数据之间没有关系，很好扩展）</p>
<p>2、大数据量，高性能（Redis一秒写8万次，读物11万次，NoSQL的缓存记录级，是一种细粒度的缓存）</p>
<p>3、数据类型是多样型的 （不需要实先设计数据库，随取随用）</p>
<p>4、传统的RDBMS和NoSQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">传统的RDBMS</span><br><span class="line">- 结构化的组织</span><br><span class="line">- SQL</span><br><span class="line">- 数据和关系都存在单独的表中</span><br><span class="line">- 操作操作，数据定义语言</span><br><span class="line">- 严格的一致性</span><br><span class="line">- 基础的事务</span><br><span class="line">- ...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NoSQL</span><br><span class="line">- 不仅仅是数据</span><br><span class="line">- 没有固定的查询语言</span><br><span class="line">- 键值对存储，列存储，文档存储，图形数据库（社交关系）</span><br><span class="line">- 最终一致性</span><br><span class="line">- CAP定理和BASE （异地多活）</span><br><span class="line">- 高性能，高可用，高可扩</span><br><span class="line">- ...</span><br></pre></td></tr></table></figure>



<blockquote>
<p>了解：3V+3高</p>
</blockquote>
<p>大数据时代的3V：主要是描述问题的</p>
<ol>
<li>海量Volume</li>
<li>多样Variety</li>
<li>实时Velocity</li>
</ol>
<p>大数据时代的3高：主要是对程序的要求</p>
<ol>
<li>高并发</li>
<li>高可括</li>
<li>高性能</li>
</ol>
<p>真正在公司中的实践：NoSQL +  RDBMS一起使用才是最强的，阿里巴巴的架构演进。</p>
<h2 id="阿里巴巴演进分析"><a href="#阿里巴巴演进分析" class="headerlink" title="阿里巴巴演进分析"></a>阿里巴巴演进分析</h2><p>大型互联网应用问题：</p>
<ul>
<li>数据类型太多了</li>
<li>数据源繁多，经常重构</li>
<li>数据要改造，大面积改造</li>
</ul>
<h2 id="NoSQL的四大分类"><a href="#NoSQL的四大分类" class="headerlink" title="NoSQL的四大分类"></a>NoSQL的四大分类</h2><p><strong>kv键值对：</strong></p>
<ul>
<li>新浪：Redis</li>
<li>美团：Redis+Tair</li>
<li>阿里、百度：Redis + memcache</li>
</ul>
<p><strong>文档型数据库（bson格式和json一样）：</strong></p>
<ul>
<li><p>MongoDB（一般必须要掌握）</p>
<ul>
<li>MongoDB是一个基于分布式文件存储的数据库，C++编写，主要用来处理大量文档</li>
<li>MongoDB是一个介于关系型数据库和非关系型数据库中中间的产品。MongoDB是非关系型数据库中功能最丰富，最像关系型数据库的。</li>
</ul>
</li>
<li><p>ConthDB</p>
</li>
</ul>
<p><strong>列存储数据库</strong></p>
<ul>
<li>HBase</li>
<li>分布式文件系统</li>
</ul>
<p><strong>图关系数据库</strong></p>
<ul>
<li>它不是存图形，放的是关系，比如：朋友圈社交网络，广告推荐</li>
<li>Neo4j，InfoGrid；</li>
</ul>
<blockquote>
<p>四者对比</p>
</blockquote>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E6%88%AA%E5%9B%BE5.PNG" alt></p>
<h1 id="Redis入门"><a href="#Redis入门" class="headerlink" title="Redis入门"></a>Redis入门</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Redis（Remote Dictionary Server )，即远程字典服务</p>
<p>是一个开源的使用ANSI <a href="https://baike.baidu.com/item/C语言" target="_blank" rel="noopener">C语言</a>编写、支持网络、可基于内存亦可持久化的日志型、Key-Value<a href="https://baike.baidu.com/item/数据库/103728" target="_blank" rel="noopener">数据库</a>，并提供多种语言的API</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E6%88%AA%E5%9B%BE6.PNG" alt></p>
<p>redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步</p>
<blockquote>
<p>Redis可以干嘛？</p>
</blockquote>
<p>1、内存存储、持久化，内存中是断电即失，所以说持久化很重要（rdb、aof）</p>
<p>2、效率高，可以用于高速缓存</p>
<p>3、发布订阅系统</p>
<p>4、地图信息分析</p>
<p>5、计时器、计数器（浏览量）</p>
<p>6、…..</p>
<blockquote>
<p>特性</p>
</blockquote>
<p>1、多样的数据结构</p>
<p>2、持久化</p>
<p>3、集群</p>
<p>4、事务</p>
<p>……</p>
<h2 id="测试性能"><a href="#测试性能" class="headerlink" title="测试性能"></a>测试性能</h2><p><strong>redis-benchmark</strong>是一个压力测试工具</p>
<p>官方自带的性能测试工具</p>
<p>redis-benchmark 命令参数</p>
<p>可以简单测试一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试：100个并发连接 100000请求</span></span><br><span class="line">redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span><br></pre></td></tr></table></figure>





<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>redis默认有16个数据库，默认适用第0个，可以使用select进行切换数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; select 3 <span class="comment">#切换数据库</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; DBSIZE <span class="comment">#查看数据库大小</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; keys * <span class="comment">#查看数据库所有的key</span></span><br><span class="line">1) <span class="string">"name"</span></span><br></pre></td></tr></table></figure>

<p>清除当前数据库  ==flushdb==</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure>

<p>清除所有的数据库 ==flushall==</p>
<blockquote>
<p>Redis是单线程的</p>
</blockquote>
<p>Redis是很快的，官方表示，Redis是基于内存操作，CPU不是Redis性能瓶颈，Redis的瓶颈是根据机器的内存和网络带宽，既然可以使用单线程来实现，就使用单线程了。</p>
<p><strong>Redis为什么单线程还这么快？</strong></p>
<p>1、误区1：高性能的服务器一定是多线程的？</p>
<p>2、误区2：多线程（CPU上下文切换）一定比单线程效率高</p>
<p>先去CPU&gt;内存&gt;硬盘的速度要有所了解</p>
<p>核心：redis是将所有的数据全部放在内存中的，所以说使用单线程去操作效率就是最高的。</p>
<h1 id="五大数据类型"><a href="#五大数据类型" class="headerlink" title="五大数据类型"></a>五大数据类型</h1><blockquote>
<p>官方文档</p>
<p>Redis是一个开源的(BSD许可)，内存中的数据结构存储，用作数据库，缓存和消息代理。它支持数据结构，如字符串、散列、列表、集合、使用范围查询的排序集合、位图、超loglog、使用半径查询的地理空间索引和流。Redis有内置的复制，Lua脚本，LRU驱逐，事务和不同级别的磁盘持久性，并提供高可用性通过Redis哨兵和自动分区与Redis集群</p>
</blockquote>
<h2 id="Redis-Key"><a href="#Redis-Key" class="headerlink" title="Redis-Key"></a>Redis-Key</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys * <span class="comment">#查看所有的key</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name zhh <span class="comment">#设置key值</span></span><br><span class="line">127.0.0.1:6379&gt; get name <span class="comment"># 获取key对应的value值</span></span><br><span class="line">127.0.0.1:6379&gt; EXPIRE name 10 <span class="comment">#设置key的过期时间，单位是秒</span></span><br><span class="line">127.0.0.1:6379&gt; ttl name <span class="comment">#查看当前key的剩余时间</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> name <span class="comment">#查看key的类型</span></span><br></pre></td></tr></table></figure>



<h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String(字符串)"></a>String(字符串)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">"v1"</span></span><br><span class="line">127.0.0.1:6379&gt; exists key1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; append key1 <span class="string">"hello"</span> <span class="comment">#追加字符串，如果当前key不存在，就相当于set key</span></span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">"v1hello"</span></span><br><span class="line">127.0.0.1:6379&gt; STRLEN key1</span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment"># i++</span></span><br><span class="line"><span class="comment"># 步长 i+= </span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> views 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line"><span class="string">"0"</span></span><br><span class="line">127.0.0.1:6379&gt; incr views <span class="comment">#自增1</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; incr views</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line"><span class="string">"2"</span></span><br><span class="line">127.0.0.1:6379&gt; decr views <span class="comment">#自减1</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; decr views</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; decr views</span><br><span class="line">(<span class="built_in">integer</span>) -1</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line"><span class="string">"-1"</span></span><br><span class="line">127.0.0.1:6379&gt; incrby views 10 <span class="comment">#可以设置步长，指定增量</span></span><br><span class="line">(<span class="built_in">integer</span>) 9</span><br><span class="line">127.0.0.1:6379&gt; incrby views 10</span><br><span class="line">(<span class="built_in">integer</span>) 19</span><br><span class="line">127.0.0.1:6379&gt; decrby views 10</span><br><span class="line">(<span class="built_in">integer</span>) 9</span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#字符串范围 range</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 <span class="string">"hello,world"</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">"hello,world"</span></span><br><span class="line">127.0.0.1:6379&gt; GETRANGE key1 0 3 <span class="comment">#截取字符串[0,3]</span></span><br><span class="line"><span class="string">"hell"</span></span><br><span class="line">127.0.0.1:6379&gt; GETRANGE key1 0 -1 <span class="comment">#获取全部字符串</span></span><br><span class="line"><span class="string">"hello,world"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#替换</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key2 abcdefg</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">"abcdefg"</span></span><br><span class="line">127.0.0.1:6379&gt; SETRANGE key2 1 xx <span class="comment">#替换指定位置开始的字符串</span></span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">"axxdefg"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment"># setex (set with expire) #设置过期时间</span></span><br><span class="line"><span class="comment"># setnx (set if not exist) #不存在才设置（在分布式锁中会常常使用）</span></span><br><span class="line">127.0.0.1:6379&gt; setex key3 30 <span class="string">"hello"</span> <span class="comment">#设置key3值为hello，30秒后过期</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(<span class="built_in">integer</span>) 25</span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line"><span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; setnx mykey <span class="string">"redis"</span> <span class="comment">#如果mykey不存在，创建mykey</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">"mykey"</span></span><br><span class="line">2) <span class="string">"key2"</span></span><br><span class="line">3) <span class="string">"key1"</span></span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(<span class="built_in">integer</span>) -2</span><br><span class="line">127.0.0.1:6379&gt; setnx mykey <span class="string">"MongoDB"</span> <span class="comment">#如果mykey存在，创建失败</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get mykey</span><br><span class="line"><span class="string">"redis"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment"># mset</span></span><br><span class="line"><span class="comment"># mget</span></span><br><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3 <span class="comment">#同时设置多个值</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">"k1"</span></span><br><span class="line">2) <span class="string">"k3"</span></span><br><span class="line">3) <span class="string">"k2"</span></span><br><span class="line">127.0.0.1:6379&gt; mget k1 k2 k3 <span class="comment">#同时获取多个值</span></span><br><span class="line">1) <span class="string">"v1"</span></span><br><span class="line">2) <span class="string">"v2"</span></span><br><span class="line">3) <span class="string">"v3"</span></span><br><span class="line">127.0.0.1:6379&gt; msetnx k1 v1 k4 v4 <span class="comment">#msetnx是一个原子操作，要么一起成功，要么一起失败</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get v4</span><br><span class="line">(nil)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#对象</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> user2 &#123;name:lisi,age:20&#125; <span class="comment">#设置一个user2对象，值为json字符来保存一个对象</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; mset user1:name zhangsan user1:age 18</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget user1:name user1:age</span><br><span class="line">1) <span class="string">"zhangsan"</span></span><br><span class="line">2) <span class="string">"18"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment">#getset 先get再set</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; getset db redis <span class="comment">#如果不存在值，则返回nil</span></span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line"><span class="string">"redis"</span> </span><br><span class="line">127.0.0.1:6379&gt; getset db mongodb <span class="comment">#如果存在值，获取原来的值，再设置新值</span></span><br><span class="line"><span class="string">"redis"</span></span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line"><span class="string">"mongodb"</span></span><br></pre></td></tr></table></figure>

<p>String类似的使用场景：value除了我们的字符串还可以是我们的数字</p>
<ul>
<li>计数器</li>
<li>统计多单位的数量</li>
<li>粉丝数</li>
<li>对象缓存存储</li>
</ul>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>基本的数据类型，列表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; lpush list one <span class="comment">#将一个值或者多个值，插入到列表头部（左）</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush list two</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush list three</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list 0 -1 <span class="comment">#获取list的中的值</span></span><br><span class="line">1) <span class="string">"three"</span></span><br><span class="line">2) <span class="string">"two"</span></span><br><span class="line">3) <span class="string">"one"</span></span><br><span class="line">127.0.0.1:6379&gt; LRANGE list 0 1 <span class="comment">#通过区间获取具体的值</span></span><br><span class="line">1) <span class="string">"three"</span></span><br><span class="line">2) <span class="string">"two"</span></span><br><span class="line">127.0.0.1:6379&gt; RPUSH list four <span class="comment">#将一个值或者多个值，插入到列表尾部（右）</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list 0 -1</span><br><span class="line">1) <span class="string">"three"</span></span><br><span class="line">2) <span class="string">"two"</span></span><br><span class="line">3) <span class="string">"one"</span></span><br><span class="line">4) <span class="string">"four"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">LPOP  <span class="comment">#移除list的第一个元素</span></span><br><span class="line">RPOP <span class="comment"># 移除list的最后一个元素</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">lindex list 1 <span class="comment">#通过下标获得list中的某一个值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"> Llen 返回list的长度</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"> 移除指定的值 Lrem</span><br><span class="line"></span><br><span class="line">lrem list 1 one <span class="comment">#移除list集合中指定个数的value，精确匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">trim 修剪 list 截断</span><br><span class="line"></span><br><span class="line">ltrim mylist 1 2 <span class="comment">#通过下标截取指定的长度，这个list已经被改变了，只剩下被截断的元素</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">rpoplpush mylist otherlist <span class="comment">#移除列表的最后一个元素，将它移动到新的列表中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">lset 将列表中指定下标的值替换为另外一个值，更新操作</span><br><span class="line"></span><br><span class="line">127.0.0.1：6379&gt; exists list <span class="comment">#判断这个列表是否存在</span></span><br><span class="line">127.0.0.1：6379&gt; lset list 0 item<span class="comment">#如果不存在列表，我们去更新就会报错</span></span><br><span class="line">127.0.0.1：6379&gt; lpush list value1</span><br><span class="line">127.0.0.1：6379&gt; lrange list 0 0 </span><br><span class="line">127.0.0.1：6379&gt; lset list 0 item <span class="comment">#如果存在，更新当前下标的值</span></span><br><span class="line">127.0.0.1：6379&gt;lset list 1 other <span class="comment">#如果不存在，则会报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">linsert <span class="comment">#将某个具体的value插入到列表中某个元素的前面或者后面</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; rpush mylist <span class="string">"hello"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist <span class="string">"world:</span></span><br><span class="line"><span class="string">Invalid argument(s)</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; rpush mylist "</span>world<span class="string">"</span></span><br><span class="line"><span class="string">(integer) 2</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; LINSERT mylist before "</span>world<span class="string">" "</span>other<span class="string">"</span></span><br><span class="line"><span class="string">(integer) 3</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; LRANGE mlist 0 -1</span></span><br><span class="line"><span class="string">(empty list or set)</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; LRANGE mylist 0 -1</span></span><br><span class="line"><span class="string">1) "</span>hello<span class="string">"</span></span><br><span class="line"><span class="string">2) "</span>other<span class="string">"</span></span><br><span class="line"><span class="string">3) "</span>world<span class="string">"</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; LINSERT mylist after "</span>world<span class="string">" "</span>xxx<span class="string">"</span></span><br><span class="line"><span class="string">(integer) 4</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; LRANGE mylist 0 -1</span></span><br><span class="line"><span class="string">1) "</span>hello<span class="string">"</span></span><br><span class="line"><span class="string">2) "</span>other<span class="string">"</span></span><br><span class="line"><span class="string">3) "</span>world<span class="string">"</span></span><br><span class="line"><span class="string">4) "</span>xxx<span class="string">"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>小结</p>
<ul>
<li>实际上是一个链表，before node after ，left，right 都可以插入值</li>
<li>如果key不存在，创建新的链表</li>
<li>如果key存在，新增内容</li>
<li>如果移除了新的值，空链表，也代表不存在。</li>
<li>再两边插入或者改动值，效率最高；中间元素，相对来说效率低一点</li>
</ul>
</blockquote>
<h2 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h2><p>set中的值是不能重复的！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">"hello"</span> <span class="comment">#set集合中添加元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">"world"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">"zhenghh"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset <span class="comment">#查看指定set的所有值</span></span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br><span class="line">3) <span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; SISMEMBER myset hello <span class="comment">#判断某一个值是不是在set集合中</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SISMEMBER myset xxx</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; SCARD myset <span class="comment">#获取set集合中元素个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; SREM myset hello <span class="comment">#移除set集合中的指定元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset </span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="built_in">set</span> 无序不重复集合 ，抽随机</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myset</span><br><span class="line"><span class="string">"world"</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myset</span><br><span class="line"><span class="string">"world"</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myset</span><br><span class="line"><span class="string">"zhenghh"</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myset 2 <span class="comment">#随机抽出指定个数的元素</span></span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">删除指定的key，随机删除key</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br><span class="line">3) <span class="string">"two"</span></span><br><span class="line">4) <span class="string">"one"</span></span><br><span class="line">127.0.0.1:6379&gt; SPOP myset <span class="comment">#随机删除一些set集合中的元素</span></span><br><span class="line"><span class="string">"world"</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">"zhenghh"</span></span><br><span class="line">2) <span class="string">"two"</span></span><br><span class="line">3) <span class="string">"one"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">将一个指定的key，移动到另外的一个集合中</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">"hello"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">"world"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">"zhenghh"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset2 <span class="string">"set2"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMOVE myset myset2 <span class="string">"zhenghh"</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset2</span><br><span class="line">1) <span class="string">"set2"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">微博，B站，共同关注（并集）</span><br><span class="line">127.0.0.1:6379&gt; SDIFF myset myset2 <span class="comment">#差集</span></span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; SINTER myset myset2 <span class="comment">#交集 共同好友就可以这样实现</span></span><br><span class="line">1) <span class="string">"zhenghh"</span></span><br><span class="line">127.0.0.1:6379&gt; SUNION myset myset2 <span class="comment">#并集</span></span><br><span class="line">1) <span class="string">"set2"</span></span><br><span class="line">2) <span class="string">"world"</span></span><br><span class="line">3) <span class="string">"zhenghh"</span></span><br><span class="line">4) <span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br><span class="line">3) <span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset2</span><br><span class="line">1) <span class="string">"set2"</span></span><br><span class="line">2) <span class="string">"zhenghh"</span></span><br></pre></td></tr></table></figure>



<h2 id="Hash（哈希）"><a href="#Hash（哈希）" class="headerlink" title="Hash（哈希）"></a>Hash（哈希）</h2><p>Map集合，key-map，这时候value为map集合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset myhash field1 hello <span class="comment">#set一个具体 key-value</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hget myhash field1 <span class="comment">#获取一个字段值</span></span><br><span class="line"><span class="string">"hello"</span></span><br><span class="line">127.0.0.1:6379&gt; hmset myhash field1 xxx field2 world <span class="comment">#set多个 key-value</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmget myhash field1 field2 <span class="comment">#获取多个字段值</span></span><br><span class="line">1) <span class="string">"xxx"</span></span><br><span class="line">2) <span class="string">"world"</span></span><br><span class="line">127.0.0.1:6379&gt; hgetall myhash <span class="comment">#获取全部的数据</span></span><br><span class="line">1) <span class="string">"field1"</span></span><br><span class="line">2) <span class="string">"xxx"</span></span><br><span class="line">3) <span class="string">"field2"</span></span><br><span class="line">4) <span class="string">"world"</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; hdel myhash field1 <span class="comment">#删除hash指定key字段，对应的value值也就消失了</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall myhash</span><br><span class="line">1) <span class="string">"field2"</span></span><br><span class="line">2) <span class="string">"world"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; hlen myhash <span class="comment">#hash里面有几对键值对</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; HEXISTS myhash field1 <span class="comment">#判断hash中的指定字段是否存在</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; HEXISTS myhash field2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; HKEYS myhash <span class="comment">#获取所有的field</span></span><br><span class="line">1) <span class="string">"field2"</span></span><br><span class="line">127.0.0.1:6379&gt; HVALS myhash <span class="comment">#获取所有的value</span></span><br><span class="line">1) <span class="string">"world"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; hset myhash field3 10</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY myhash field3 2 <span class="comment">#指定增量</span></span><br><span class="line">(<span class="built_in">integer</span>) 12</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY myhash field3 -6</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; hsetnx myhash field3 22</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; hsetnx myhash field4 hahah <span class="comment">#如果不存在则可以设置</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hsetnx myhash field4 ha <span class="comment">#如果存在则不可以设置</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<p>hash变更的数据user name age ，尤其是用户信息之类的，经常变动的信息。hash更适用于对象的存储，String更适用于字符串的存储。</p>
<h2 id="Zset（有序集合）"><a href="#Zset（有序集合）" class="headerlink" title="Zset（有序集合）"></a>Zset（有序集合）</h2><p>在set的基础上，增加了一个值，set k1 v1  zset k1 score1 v1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; zadd myset 1 one <span class="comment">#添加一个值</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myset 2 two 3 three  <span class="comment">#添加多个值</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; ZRANGE myset 0 -1</span><br><span class="line">1) <span class="string">"one"</span></span><br><span class="line">2) <span class="string">"two"</span></span><br><span class="line">3) <span class="string">"three"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">实现排序</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; zadd salary 2500 xiaoming</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 5000 zhangsan</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 2000 lisi</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ZRANGEBYSCORE salary min max </span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf  <span class="comment">#显示全部用户 从小到大</span></span><br><span class="line">1) <span class="string">"lisi"</span></span><br><span class="line">2) <span class="string">"xiaoming"</span></span><br><span class="line">3) <span class="string">"zhangsan"</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf withscores <span class="comment">#显示全部用户并且附带成绩</span></span><br><span class="line">1) <span class="string">"lisi"</span></span><br><span class="line">2) <span class="string">"2000"</span></span><br><span class="line">3) <span class="string">"xiaoming"</span></span><br><span class="line">4) <span class="string">"2500"</span></span><br><span class="line">5) <span class="string">"zhangsan"</span></span><br><span class="line">6) <span class="string">"5000"</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf 2500 withscores</span><br><span class="line">1) <span class="string">"lisi"</span></span><br><span class="line">2) <span class="string">"2000"</span></span><br><span class="line">3) <span class="string">"xiaoming"</span></span><br><span class="line">4) <span class="string">"2500"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逆序输出</span></span><br><span class="line">127.0.0.1:6379&gt; ZREVRANGEBYSCORE salary +inf -inf withscores</span><br><span class="line">1) <span class="string">"zhangsan"</span></span><br><span class="line">2) <span class="string">"5000"</span></span><br><span class="line">3) <span class="string">"xiaoming"</span></span><br><span class="line">4) <span class="string">"2500"</span></span><br><span class="line">5) <span class="string">"lisi"</span></span><br><span class="line">6) <span class="string">"2000"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除rem的元素</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGE salary 0 -1</span><br><span class="line">1) <span class="string">"lisi"</span></span><br><span class="line">2) <span class="string">"xiaoming"</span></span><br><span class="line">3) <span class="string">"zhangsan"</span></span><br><span class="line">127.0.0.1:6379&gt; ZREM salary xiaoming</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ZRANGE salary 0 -1</span><br><span class="line">1) <span class="string">"lisi"</span></span><br><span class="line">2) <span class="string">"zhangsan"</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; ZCARD salary <span class="comment">#获取有序集合中的个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">127.0.0.1:6379&gt; zcount salary -inf +inf <span class="comment">#获取指定区间的元素个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure>

<p>其余的API都可以查阅官方文档</p>
<h1 id="三种特殊数据类型"><a href="#三种特殊数据类型" class="headerlink" title="三种特殊数据类型"></a>三种特殊数据类型</h1><h2 id="geospatial（地理位置）"><a href="#geospatial（地理位置）" class="headerlink" title="geospatial（地理位置）"></a>geospatial（地理位置）</h2><p>朋友的定位，附近的人，打车距离计算</p>
<blockquote>
<p>geoadd</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># geoadd 地理位置</span></span><br><span class="line"><span class="comment">#规则：两级无法直接添加，我们一般会下载城市数据，直接通过java程序一次性导入</span></span><br><span class="line"><span class="comment"># 参数 key </span></span><br><span class="line">127.0.0.1:6379&gt; GEOADD china:city 116.40 39.90 beijin</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; GEOADD china:city 121.47 31.23 shanghai</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; GEOADD china:city 106.50 29.53 chongqing</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>geopos</p>
</blockquote>
<p>获得当前的定位：一定是一个坐标值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOPOS china:city beijin <span class="comment">#获取指定的城市的经度和纬度</span></span><br><span class="line">1) 1) <span class="string">"116.39999896287918091"</span></span><br><span class="line">   2) <span class="string">"39.90000009167092543"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>geodist</p>
</blockquote>
<p>两人之间的距离</p>
<p>单位：</p>
<ul>
<li>m表示单位为米</li>
<li>km表示单位为千米</li>
<li>mi表示单位为英里</li>
<li>ft表示单位为英尺</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEODIST china:city beijin shanghai km</span><br><span class="line"><span class="string">"1067.3788"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>georadius以给定的经纬度为中心，找出某一半径内的元素</p>
</blockquote>
<p>我附近的人？（获得所有附近的人的地址，定位！）通过半径来查询！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km <span class="comment">#以110，30这个经纬度为中心，寻找方圆1000km的城市</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>georadiusbymember    #找出位于指定元素周围的其他元素！</p>
</blockquote>
<blockquote>
<p>geohash命令-返回一个或多个位置元素的geohash表示</p>
</blockquote>
<blockquote>
<p><strong>geo底层的实现原理其实就是Zset，我们可以使用Zset命令来操作geo</strong></p>
</blockquote>
<h2 id="hyperloglog"><a href="#hyperloglog" class="headerlink" title="hyperloglog"></a>hyperloglog</h2><p>Redis Hyperloglog 基数统计的算法</p>
<p>优点：占用的内存是固定的，2^64不同的元素的技术，只需要12KB的内存。如果要从内存角度来比较的话Hyperloglog首选。</p>
<p><strong>网页的PV（一个人访问网站多次，但是还是算作一个人）</strong></p>
<p>传统的方式，set保存用户的id，然后就可以统计set中元素数量作为标准判断！</p>
<p>这个方式如果保存大量的用户id，就会比较麻烦。我们的目的是为了计数，而不是保存用户的id。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD mykey a b c d e f <span class="comment">#创建第一组元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT mykey <span class="comment">#统计mykey中基数数量</span></span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; PFADD mykey2 q w e r a</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT mykey2</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; PFMERGE reskey mykey mykey2 <span class="comment">#合并两组 mykey mykey2 到 reskey</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT reskey</span><br><span class="line">(<span class="built_in">integer</span>) 9</span><br></pre></td></tr></table></figure>

<p>如果允许容错，那么一定可以使用Hyperloglog ！</p>
<p>如果不允许容错，那么就使用set或者自己的数据类型即可！</p>
<h2 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h2><p>统计用户信息，活跃，不活跃。登录，未登录。打卡，未打卡。两个状态，都可以使用bitmap。</p>
<p>Bitmap位图，数据结构，都是操作二进制来进行记录，就只有0和1两个状态。</p>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>Redis事务本质：一组命令集合。一个事务中的所有命令都会被序列化，在事务执行过程中，会按照顺序执行。</p>
<p>一次性、顺序性、排他性，执行一系列的命令。</p>
<p>==Redis事务没有隔离级别的概念==</p>
<p>所有的命令在事务中，并没有直接被执行，只有发起执行命令的时候才会执行。</p>
<p>==Redis单条命令是保证原子性的，但是事务不保证原子性==</p>
<p>redis事务：</p>
<ul>
<li>开启事务（multi）</li>
<li>命令入队（…..）</li>
<li>执行事务（exec）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI <span class="comment">#开启事务</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment">#命令入队</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC <span class="comment">#执行事务</span></span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) <span class="string">"v1"</span></span><br><span class="line">4) OK</span><br></pre></td></tr></table></figure>

<blockquote>
<p>放弃事务</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k4 v4</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; DISCARD</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k4</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>编译型异常（代码有问题，命令有错），事务中所有的命令都不会被执行</p>
</blockquote>
<blockquote>
<p>运行时异常（1/0），如果事务队列中存在语法性，那么执行命令的时候，其他命令是可以正常执行的。错误命令抛出异常。</p>
</blockquote>
<blockquote>
<p>监控 Watch（面试常问）</p>
</blockquote>
<p><strong>悲观锁：</strong></p>
<ul>
<li>很悲观，认为什么时候都会出问题，无论做什么都会加锁</li>
</ul>
<p><strong>乐观锁：</strong></p>
<ul>
<li>很乐观，认为什么时候都不会出问题，所以不会上锁，更新数据的时候去判断一下，在此期间是否有人修改过这个数据。</li>
<li>获取version</li>
<li>更新的时候比较version</li>
</ul>
<blockquote>
<p>Redis监视测试</p>
</blockquote>
<p>正常执行成功情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money <span class="comment">#监视money对象</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi <span class="comment">#事务正常结束，数据期间没有发生变动，这个时候就正常执行成功。</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; DECRBY money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; INCRBY out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 80</span><br><span class="line">2) (<span class="built_in">integer</span>) 20</span><br></pre></td></tr></table></figure>

<p>测试多线程修改值，使用watch可以当作redis的乐观锁操作。</p>
<h1 id="jedis"><a href="#jedis" class="headerlink" title="jedis"></a>jedis</h1><p>我们要使用Java来操作Redis</p>
<blockquote>
<p>什么是Jedis，这是官方推荐的java连接开发工具，使用java操作Redis中间件。</p>
</blockquote>
<p>1、导入对应的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入jedis包--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--fastjson--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.60<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、编码测试：</p>
<ol>
<li>连接数据库</li>
<li>操作命令</li>
<li>获得结果</li>
</ol>
<h1 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h1><p>SpringBoot操作数据：spring-data jpa jdbc mongodb redis</p>
<p>SpringData也是和SpringBoot齐名的项目</p>
<p>==说明：在SpringBoot2.x之后，原来使用的jedis被替换成为了lettuce==</p>
<p>jedis：采用的直连，多个线程操作的话，是不安全的，如果想要避免不安全的，就要使用jedis pool连接池</p>
<p>lettuce：采用jetty，实例可以在多个线程中进行共享，不存在线程不安全的情况。可以减少线程数量。</p>
<p>1、导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--操作redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置连接</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis配置</span></span><br><span class="line"><span class="meta">spring.redis.host</span>= <span class="string">192.168.253.130</span></span><br><span class="line"><span class="meta">spring.redis.port</span>= <span class="string">6379</span></span><br><span class="line"><span class="meta">spring.redis.password</span>= <span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p>3、测试</p>
<h1 id="Redis-conf详解"><a href="#Redis-conf详解" class="headerlink" title="Redis.conf详解"></a>Redis.conf详解</h1><p>启动的时候，就通过配置文件来启动。</p>
<p>1、配置文件unit单位对大小写不敏感。</p>
<blockquote>
<p>网络</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1 <span class="comment">#绑定的ip</span></span><br><span class="line">protected-mode yes <span class="comment">#保护模式</span></span><br><span class="line">port 6379 <span class="comment">#端口设置</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes <span class="comment">#以守护进程的方式运行，默认是no，我们需要自己开启为yes</span></span><br><span class="line"></span><br><span class="line">pidfile /var/run/redis_6379.pid <span class="comment">#如果以后台的方式运行，我们需要指定一个pid文件</span></span><br><span class="line"></span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">""</span> <span class="comment">#日志文件位置名</span></span><br><span class="line">database 16 <span class="comment">#数据库的数量，默认是16个数据库</span></span><br><span class="line">always-show-logo yes <span class="comment">#是否总是显示logo</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>快照</p>
</blockquote>
<p>持久化，在规定时间内，执行了多少次操作，则会持久化到文件.rdb .aof</p>
<p>redis是内存数据库，如果没有持久化，那么数据断电丢失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果900s内，如果至少有一个1key进行了修改，我们应及时进行持久化操作</span></span><br><span class="line">save 900 1</span><br><span class="line"><span class="comment">#如果900s内，如果至少有一个10 key进行了修改，我们应及时进行持久化操作</span></span><br><span class="line">save 300 10</span><br><span class="line"><span class="comment">#如果900s内，如果至少有一个100000 key进行了修改，我们应及时进行持久化操作</span></span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment">#我们之后学习持久化，会自己定义这个测试</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error yes <span class="comment">#持久化如果出错，是否还需要继续工作</span></span><br><span class="line"></span><br><span class="line">rdbcompression yes <span class="comment">#是否压缩rdb文件，需要消耗一些cpu资源</span></span><br><span class="line">rdbchecksum yes <span class="comment">#保存rdb文件时，进行错误的检查校验</span></span><br><span class="line">dir ./ <span class="comment">#rdb文件保存目录</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>REPLICATION 复制，后面讲解主从复制时，再进行讲解</p>
</blockquote>
<blockquote>
<p>SECURITY 安全</p>
</blockquote>
<p>可以在这里设置redis的密码，默认是没有密码的。</p>
<blockquote>
<p>限制 CLIENTS</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">maxclients 10000 <span class="comment">#设置能连接上redis的最大客户端的数量</span></span><br><span class="line">maxmemory &lt;bytes&gt; <span class="comment">#redis配置最大的内存容量</span></span><br><span class="line">maxmemory-policy noeviction <span class="comment">#内存到达上限之后的处理策略</span></span><br><span class="line">    1、volatile-lru：只对设置了过期时间的key进行LRU（默认值）</span><br><span class="line">    2、allkeys-lru：删除lru算法的key</span><br><span class="line">    3、volatile-random：随机删除即将过期key</span><br><span class="line">    4、allkeys-random：随机删除</span><br><span class="line">    5、volatile-ttl：删除即将过期的</span><br><span class="line">    6、noeviction：永不过期，返回错误</span><br></pre></td></tr></table></figure>

<blockquote>
<p>APPEND ONLY 模式 aof配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">appendonly no <span class="comment">#默认是不开启aof模式的，默认是使用rdb方式持久化的</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span> <span class="comment">#持久化的文件的名字</span></span><br></pre></td></tr></table></figure>





<h1 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h1><p>Redis是内存数据库，如果不能将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失，所以Redis提供了持久化功能。</p>
<h2 id="RDB（Redis-DataBase）"><a href="#RDB（Redis-DataBase）" class="headerlink" title="RDB（Redis DataBase）"></a>RDB（Redis DataBase）</h2><blockquote>
<p>什么是RDB</p>
</blockquote>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/RDB.PNG" alt></p>
<p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是所谓的Snapshot快照，它恢复时是将快照文件直接读到内存里。Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的。这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF反式更加的高效。RDB的缺点式最后一次持久化后的数据可能会丢失。</p>
<p>==rdb保存的文件是dump.rdb文件==</p>
<blockquote>
<p>触发机制</p>
</blockquote>
<p>1、save的规则满足的情况下，会自动触发rdb规则</p>
<p>2、执行flushall命令，也会触发rdb规则</p>
<p>3、退出redis，也会产生rdb文件</p>
<p>备份就会自动生成一个dump.rdb文件</p>
<blockquote>
<p>如何从rdb文件中恢复数据</p>
</blockquote>
<p>1、只需要将rdb文件放在redis启动目录就可以，redis启动的时候会自动检查dump.rdb</p>
<p>2、查看需要存在的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get dir</span><br></pre></td></tr></table></figure>

<p>优点：</p>
<p>1、适合大规模的数据恢复</p>
<p>2、对数据的完整性要求不高</p>
<p>缺点：</p>
<p>1、需要一定的时间间隔进程操作，如果redis意外宕机了，这个最后一次修改数据就没有了</p>
<p>2、fork进程的时候，会占用一定的内存空间。</p>
<h2 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h2><p>将所有命令都记录下来，恢复的时候就把这个文件全部再执行一遍。</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/AOF.PNG" alt></p>
<p>以日志的形式来记录每一个写操作，将Redis执行过的所有指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p>
<p>==Aof保存的是appendonly.aof文件==</p>
<p>默认是不开启的，我们需要手动进行配置，我们只需要将appendonly改为yes就开启了aof</p>
<p>重启，redis就可以生效了。</p>
<p>如果这个aof文件有错误，这时候redis是启动不起来的，我们需要修复这个aof文件</p>
<p>redis提供了一个修复工具 <code>redis-check-aof --fix</code> </p>
<p>如果aof文件大于64M，大太了，fork一个新的进程来将我们的文件进行读写。</p>
<p>优点：</p>
<p>1、每次修改都同步，文件的完整性会更好</p>
<p>2、每秒同步一秒，可能会丢失一秒的数据</p>
<p>缺点：</p>
<p>1、相对于数据文件来说，aof远远大于rdb，修复的速度也比rdb慢</p>
<p>2、Aof运行效率也要比rdb慢，所以redis默认的配置就是rdb持久化。</p>
<h1 id="Redis发布订阅"><a href="#Redis发布订阅" class="headerlink" title="Redis发布订阅"></a>Redis发布订阅</h1><p>Redis发布订阅（pub/sub）是一种消息通信模式：发送者（pub）发送消息，订阅者（sub）接受消息。微信、微博、关注系统。</p>
<p>Redis客户端可以订阅任意数量的频道。</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85.PNG" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1、PSUBSCRIBE pattern[pattern...] <span class="comment">#订阅一个或者多个符合给定模式的频道</span></span><br><span class="line"></span><br><span class="line">2、PUBSUB subcommand [argument [argument...]] <span class="comment">#查看订阅于发布系统状态</span></span><br><span class="line"></span><br><span class="line">3、PUBLISH channel message <span class="comment">#将消息发送到指定的频道</span></span><br><span class="line"></span><br><span class="line">4、PUNSUBSCRIBE [pattern [pattern...]] <span class="comment">#退订所有给定模式的频道</span></span><br><span class="line"></span><br><span class="line">5、SUBSCRIBE channel [channel...] <span class="comment">#订阅给定的一个或者多个频道的信息</span></span><br><span class="line"></span><br><span class="line">6、UNSUBSCRIBE [channel [channel...]] <span class="comment">#退订给定的频道</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<p>订阅端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SUBSCRIBE zhenghh <span class="comment">#订阅一个频道 zhenghh</span></span><br><span class="line"></span><br><span class="line">1) <span class="string">"message"</span> <span class="comment">#消息</span></span><br><span class="line">2) <span class="string">"zhenghh"</span> <span class="comment">#消息来自哪个频道</span></span><br><span class="line">3) <span class="string">"hello world!"</span> <span class="comment">#消息内容</span></span><br></pre></td></tr></table></figure>

<p>发送端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PUBLISH zhenghh <span class="string">"hello world!"</span> <span class="comment">#发布者发送消息到指定的频道</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>原理</p>
</blockquote>
<p>Redis是使用C实现的，通过分析Redis源码里面的pubsub.c文件，了解发布和订阅机制的底层实现，藉此加深对Redis的理解。Redis通过PUBLISH、SUBSCRIBE和PSUBSCRIBE等命令实现发布和订阅功能。</p>
<p>通过SUBSCRIBE命令订阅某频道后，redis-server里维护了一个字典，字典的键就是一个个channel，而字典的值则是一个链表，链表中保存了所有订阅这个channel的客户端。SUBSCRIBE命令的关键，就是将客户端添加到给定channel的订阅链表中。</p>
<p>通过PUBLISH命令向订阅者发送信息，redis-server会使用给定的频道作为键，在它所维护的channel字典查找记录了订阅这个频道的所有客户端的链表，遍历这个链表，将消息发布给所有订阅者。</p>
<p>Pub/Sub从字面上理解就是发布（Publish）与订阅（Subscribe），在Redis中，你可以设定对某一个key值进行消息发布及消息订阅，当一个key值上进行了消息发布后，所有订阅它的客户端都会收到相应的消息。这一功能最明显的用法就是用作实时消息系统，比如普通的即时聊天，群聊等功能。</p>
<h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器，前者称为主节点，后者称为从节点。数据的复制是单向的，==只能由主节点到从节点==。Master以写为主，Slave以读为主。</p>
<p>默认情况下，每台Redis服务器都是主节点；且一个主节点可以有多个从节点（或者没有从节点），但一个从节点只能有一个主节点。</p>
<p>主从复制的作用主要包括：</p>
<p>1、数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</p>
<p>2、故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</p>
<p>3、负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。</p>
<p>4、高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。</p>
<p>==一般来说，单台Redis最大使用内存不应该超过20G==</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.PNG" alt></p>
<p>主从复制，读写分离。80%的情况下都是在进行读操作，减轻服务器的压力。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>只配置从库，不用配置主库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication <span class="comment">#查看当前库的信息</span></span><br></pre></td></tr></table></figure>



<h2 id="一主二从"><a href="#一主二从" class="headerlink" title="一主二从"></a>一主二从</h2><p>只需要配从机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1：6380&gt; slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>

<p>==真实的主从配置应该在配置文件中配置的，这样的话是永久的==</p>
<blockquote>
<p>复制原理</p>
</blockquote>
<p>Slave启动成功连接到master后会发送一个sync同步命令。</p>
<p>Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master将传送整个数据文件到slave，并完成一个完全同步。</p>
<p>全量复制：slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。</p>
<p>增量复制：Master继续将新的所有收集到的修改命令依次传给slave，完成同步。</p>
<p>但是只要是重新连接master，一次完全同步（全量复制）将被自动执行。</p>
<p>==如果主机断开连接，我们可以使用<code>slaveof no one</code> 让自己变成主机==</p>
<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><p>（自动选举老大的模式）</p>
<p>主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费时费力，还会造成一段时间内服务不可用。这是一种推荐的方式，更多时候，我们优先考虑哨兵模式。它能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。</p>
<p>哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是<strong>哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实列。</strong></p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F.PNG" alt></p>
<p>然而一个哨兵进程对Redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成多哨兵模式。</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E5%A4%9A%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F.PNG" alt></p>
<p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象称为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover[故障转移]操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong></p>
<blockquote>
<p>规则：如果原主机此时回来了，只能归并到新的主机下，当作从机。</p>
</blockquote>
<p>优点：</p>
<p>1、哨兵集群，基于主从复制模式，所有的主从配置优点都有</p>
<p>2、主从可以切换，故障可以转移，系统的可用性更好</p>
<p>3、哨兵模式就是主从模式的升级，手动到自动，更加健壮</p>
<p>缺点：</p>
<p>1、Redis不好在线扩容，集群容量一旦到达上限，在线扩容就十分麻烦</p>
<p>2、实现哨兵模式的配置其实是很麻烦的，里面有很多选择</p>
<h1 id="Redis缓存穿透和雪崩（高频）"><a href="#Redis缓存穿透和雪崩（高频）" class="headerlink" title="Redis缓存穿透和雪崩（高频）"></a>Redis缓存穿透和雪崩（高频）</h1><h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><blockquote>
<p>概念</p>
</blockquote>
<p>缓存穿透是指，用户想要查询一个数据，发现redis内存数据库中没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中，于是都去请求了持久层数据库，这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><p>布隆过滤器是一种数据结构，对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的查询压力。</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8.PNG" alt></p>
<h3 id="缓存空对象"><a href="#缓存空对象" class="headerlink" title="缓存空对象"></a>缓存空对象</h3><p>当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据库将会从缓存中获取，保护了后端数据源。</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E7%BC%93%E5%AD%98%E7%A9%BA%E5%AF%B9%E8%B1%A1.PNG" alt></p>
<p>但是这种方法会存在两个问题：</p>
<p>1、如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键</p>
<p>2、即使对空值设置了过期时间，还是会存在缓存层和储存层的数据会有一段时间窗口的不一致，这对于需要保持一致的业务会有影响。</p>
<h2 id="缓存击穿（量太大，缓存过期）"><a href="#缓存击穿（量太大，缓存过期）" class="headerlink" title="缓存击穿（量太大，缓存过期）"></a>缓存击穿（量太大，缓存过期）</h2><blockquote>
<p>概述</p>
</blockquote>
<p>这里需要注意和缓存击穿的区别，缓存击穿，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个key在失效的瞬间，持续的大并发就击破缓存，直接请求数据库，就像一个屏障上凿开了一个洞。</p>
<p>当某个key在过期的瞬间，有大量的请求并发访问，这类数据一般是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并回写缓存，会导致数据库瞬间压力过大。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<h3 id="设置热点数据永不过期"><a href="#设置热点数据永不过期" class="headerlink" title="设置热点数据永不过期"></a>设置热点数据永不过期</h3><p>从缓存层面来看。没有设置过期时间，所以不会出现热点key过期后产生的问题。</p>
<h3 id="加互斥锁"><a href="#加互斥锁" class="headerlink" title="加互斥锁"></a>加互斥锁</h3><p>分布式锁：使用分布式锁，保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。</p>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><blockquote>
<p>概念</p>
</blockquote>
<p>缓存雪崩，是指在某个时间段，缓存集中过期失效。Redis宕机。</p>
<p>产生雪崩的原因之一，比如在写文本的时候，马上就要到双十二零点，很快就会迎来一波抢购，这波商品时间比较集中的放入了缓存，假设缓存一个小时，那么到了凌晨一点钟的时候，这批商品的缓存就都过期了。而对这批商品的访问查询，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。于是所有的请求都会达到存储层，存储层的调用量就会暴增，造成存储层也会挂掉的情况。</p>
<p><img src="/2020/07/28/redis%E7%AC%94%E8%AE%B0/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9.PNG" alt></p>
<p>其实集中过期，倒不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或者断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候，数据库也可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间就把服务器压垮。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<h3 id="redis高可用"><a href="#redis高可用" class="headerlink" title="redis高可用"></a>redis高可用</h3><p>这个思想的含义是，既然redis有可能挂掉，那我多增设几台redis，这样一台挂掉之后，其他的还可以继续工作，其实就是搭建的集群。（异地多活）</p>
<h3 id="限流降级"><a href="#限流降级" class="headerlink" title="限流降级"></a>限流降级</h3><p>这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。</p>
<h3 id="数据预热"><a href="#数据预热" class="headerlink" title="数据预热"></a>数据预热</h3><p>数据加热的含义就是在正式部署之前，我先把可能的数据先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀。</p>

        
    </section>
</article>



<a id="pagenext" href="/2020/07/12/%E6%95%B4%E5%90%88SSM/" class="article-next" title="整合SSM"><i class="icon-arrow-right"></i></a>




<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "7fbe80427f54741e289f",
        clientSecret: "f34ed5fd92e54c9000bd37ba951948cb939deff5",
        repo: "sanonz.github.io",
        owner: "sanonz",
        admin: ["sanonz"],
        id: "2020/07/28/redis笔记",
        distractionFreeMode: true,
        title: "redis笔记",
        body: "http://yoursite.com/2020/07/28/redis%E7%AC%94%E8%AE%B0/",
        labels: ["NoSql"]
    }).render('comments');
    </script>
</div>


            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            console.log($(this).width())
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
